# å­—å¹•ç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

é‡æ„åçš„å­—å¹•ç³»ç»Ÿé‡‡ç”¨**ç»Ÿä¸€ç®¡ç†å™¨**æ¨¡å¼ï¼Œæä¾›æ¸…æ™°çš„æ¶æ„å’Œå¤šç§å¯¹é½æ–¹æ¡ˆï¼š

```
å­—å¹•ç³»ç»Ÿ/
â”œâ”€â”€ subtitle_alignment_manager.py    # ç»Ÿä¸€å­—å¹•å¯¹é½ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”œâ”€â”€ subtitle_processor.py           # åŸºç¡€å­—å¹•å¤„ç†å™¨ï¼ˆæ–‡æœ¬åˆ†å‰²ç­‰ï¼‰
â”œâ”€â”€ jianying_subtitle_renderer.py   # å‰ªæ˜ é£æ ¼å­—å¹•æ¸²æŸ“å™¨
â”œâ”€â”€ whisper_alignment.py            # WhisperXç²¾ç¡®å¯¹é½å™¨ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ å…¶ä»–å­—å¹•ç›¸å…³ç»„ä»¶...
```

## ğŸ“‹ æ ¸å¿ƒç»„ä»¶

### 1. SubtitleAlignmentManagerï¼ˆæ ¸å¿ƒç®¡ç†å™¨ï¼‰
- **ä½œç”¨**: ç»Ÿä¸€ç®¡ç†å¤šç§å­—å¹•å¯¹é½æ–¹æ¡ˆ
- **ä½ç½®**: `video/subtitle_alignment_manager.py`
- **æ”¯æŒçš„å¯¹é½æ–¹æ¡ˆ**:
  1. **WhisperXç²¾ç¡®å¯¹é½** (ä¼˜å…ˆçº§æœ€é«˜)
  2. **TTSæ—¶é—´æˆ³+æ™ºèƒ½åˆ†å‰²** (ä¸»è¦fallback)
  3. **æ–‡æœ¬é•¿åº¦ä¼°è®¡å¯¹é½** (æœ€åå¤‡é€‰)

### 2. WhisperXAlignerï¼ˆå¯é€‰ç»„ä»¶ï¼‰
- **ä½œç”¨**: æä¾›è¯çº§åˆ«ç²¾ç¡®æ—¶é—´æˆ³å¯¹é½
- **ä½ç½®**: `media/whisper_alignment.py`
- **ç‰¹ç‚¹**: 
  - 70xå®æ—¶è½¬å½•é€Ÿåº¦
  - æ”¯æŒä¸­æ–‡è¯çº§åˆ«å¯¹é½
  - åŸºäºwav2vec 2.0å¼ºåˆ¶å¯¹é½æŠ€æœ¯

### 3. SubtitleProcessorï¼ˆåŸºç¡€å¤„ç†å™¨ï¼‰
- **ä½œç”¨**: æ–‡æœ¬æ™ºèƒ½åˆ†å‰²ã€SRTç”Ÿæˆç­‰åŸºç¡€åŠŸèƒ½
- **ä½ç½®**: `video/subtitle_processor.py`
- **æ ¸å¿ƒåŠŸèƒ½**: 12å­—ç¬¦/è¡Œæ™ºèƒ½åˆ†å‰²ã€æ—¶é—´åˆ†é…

### 4. JianyingSubtitleRendererï¼ˆè§†è§‰æ¸²æŸ“å™¨ï¼‰
- **ä½œç”¨**: å‰ªæ˜ é£æ ¼ç¡¬ç¼–ç å­—å¹•æ¸²æŸ“
- **ä½ç½®**: `video/jianying_subtitle_renderer.py`
- **ç‰¹ç‚¹**: åŠé€æ˜èƒŒæ™¯ã€ç™½è‰²å­—ä½“ã€ç§»åŠ¨ç«¯ä¼˜åŒ–

## ğŸ”„ å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[éŸ³é¢‘æ–‡ä»¶ + è„šæœ¬æ–‡æœ¬] --> B[SubtitleAlignmentManager]
    B --> C{WhisperXå¯ç”¨?}
    C -->|æ˜¯| D[WhisperXç²¾ç¡®å¯¹é½]
    C -->|å¦| E{æœ‰TTSæ—¶é—´æˆ³?}
    E -->|æ˜¯| F[TTS + æ™ºèƒ½åˆ†å‰²]
    E -->|å¦| G[æ–‡æœ¬é•¿åº¦ä¼°è®¡]
    D --> H[ç»Ÿä¸€å­—å¹•ç»“æœ]
    F --> H
    G --> H
    H --> I[JianyingSubtitleRenderer]
    I --> J[æœ€ç»ˆè§†é¢‘ + å­—å¹•]
```

## âš™ï¸ é…ç½®å‚æ•°

### WhisperXé…ç½® (`config/settings.json`)
```json
{
  "whisperx": {
    "enabled": false,              // æ˜¯å¦å¯ç”¨WhisperX
    "model_size": "large-v3",      // æ¨¡å‹å¤§å°
    "device": "auto",              // è®¾å¤‡é€‰æ‹©
    "language": "zh",              // è¯­è¨€ä»£ç 
    "batch_size": 16               // æ‰¹å¤„ç†å¤§å°
  }
}
```

### å­—å¹•é…ç½®
```json
{
  "subtitle": {
    "max_line_length": 12,          // æ¯è¡Œæœ€å¤§å­—ç¬¦æ•°
    "max_duration_per_subtitle": 3.0 // æ¯æ¡å­—å¹•æœ€å¤§æ—¶é•¿
  }
}
```

## ğŸ“Š å¯¹é½æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ç²¾åº¦ | é€Ÿåº¦ | ä¾èµ– | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| WhisperX | æœ€é«˜ | å¿« | torch, whisperx | ç”Ÿäº§ç¯å¢ƒï¼Œé«˜è´¨é‡è¦æ±‚ |
| TTS + æ™ºèƒ½åˆ†å‰² | ä¸­ç­‰ | æœ€å¿« | æ— é¢å¤–ä¾èµ– | å¼€å‘ç¯å¢ƒï¼Œå¿«é€ŸåŸå‹ |
| æ–‡æœ¬é•¿åº¦ä¼°è®¡ | è¾ƒä½ | æœ€å¿« | æ— é¢å¤–ä¾èµ– | æœ€åå¤‡é€‰ï¼Œå…¼å®¹æ€§ä¼˜å…ˆ |

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```python
from video.subtitle_alignment_manager import SubtitleAlignmentManager, AlignmentRequest

# åˆå§‹åŒ–ç®¡ç†å™¨
manager = SubtitleAlignmentManager(config, file_manager)

# åˆ›å»ºå¯¹é½è¯·æ±‚
request = AlignmentRequest(
    audio_file="audio.mp3",
    script_text="å®Œæ•´è„šæœ¬æ–‡æœ¬",
    language="zh",
    max_chars_per_line=12
)

# æ‰§è¡Œå¯¹é½
result = manager.align_subtitles(request)
print(f"ä½¿ç”¨æ–¹æ¡ˆ: {result.method}")
print(f"ç”Ÿæˆå­—å¹•æ®µæ•°: {result.total_segments}")
```

### é«˜çº§ç”¨æ³•
```python
# è·å–å¯¹é½ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_alignment_stats(result)
print(f"ç½®ä¿¡åº¦: {stats['confidence_score']}")
print(f"å¹³å‡æ¯æ®µæ—¶é•¿: {stats['avg_duration_per_segment']:.2f}s")

# ä¿å­˜å­—å¹•æ–‡ä»¶
manager.save_alignment_result(result, "output.srt")

# æ¸…ç†èµ„æº
manager.cleanup()
```

## ğŸš€ å®‰è£…WhisperXï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æœ€é«˜ç²¾åº¦çš„å­—å¹•å¯¹é½ï¼Œå¯ä»¥å®‰è£…WhisperXï¼š

```bash
# å®‰è£…WhisperXä¾èµ–
pip install -r requirements-whisperx.txt

# å¯ç”¨WhisperX
# åœ¨config/settings.jsonä¸­è®¾ç½® "whisperx.enabled": true
```

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

1. **ç»Ÿä¸€æ¥å£**: ä¸€ä¸ªç®¡ç†å™¨ï¼Œå¤šç§æ–¹æ¡ˆï¼Œè°ƒç”¨ç®€å•
2. **æ™ºèƒ½å›é€€**: è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯ç”¨æ–¹æ¡ˆï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
3. **é«˜åº¦å¯é…ç½®**: æ”¯æŒå¤šç§å‚æ•°è°ƒæ•´ï¼Œé€‚åº”ä¸åŒéœ€æ±‚
4. **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†æ¨¡å‹ç¼“å­˜ï¼Œå†…å­˜ä½¿ç”¨ä¼˜åŒ–
5. **è°ƒè¯•å‹å¥½**: æä¾›è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯å’Œè°ƒè¯•æ–‡ä»¶
6. **æ¶æ„æ¸…æ™°**: å„ç»„ä»¶èŒè´£æ˜ç¡®ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

è¿™ä¸ªæ–°æ¶æ„å¤§å¤§ç®€åŒ–äº†main.pyçš„å¤æ‚æ€§ï¼ŒåŒæ—¶æä¾›äº†æ›´å¼ºå¤§å’Œçµæ´»çš„å­—å¹•å¤„ç†èƒ½åŠ›ã€‚